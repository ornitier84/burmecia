Role Name
=========

An [Ansible] role to provision a [Docker] swarm cluster.

Requirements
------------

Install [Ansible] roles required:
```
sudo ansible-galaxy install -r requirements.yml
```

Role Variables
--------------

```
---
# defaults file for ansible-docker-swarm
docker_swarm_addr: "{{ hostvars[inventory_hostname]['ansible_' + docker_swarm_interface]['ipv4']['address'] }}"

# Validity period for node certificates (default 2160h0m0s)
docker_swarm_cert_expiry: '2160h0m0s'

# Dispatcher heartbeat period (default 5s)
docker_swarm_dispatcher_heartbeat_duration: '5s'

docker_swarm_interface: "enp0s8"
# docker_swarm_managers_ansible_group: 'docker-swarm-managers'

docker_swarm_config_networks: false
docker_swarm_config_settings: false

# Define Ansible group which contains your Docker swarm managers
docker_swarm_managers_ansible_group: 'docker-swarm-managers'

docker_swarm_networks: []
  # - name: 'my_net'
  #   driver: 'overlay'
  #   state: 'present'
  # - name: 'test'
  #   driver: 'overlay'
  #   state: 'absent'
docker_swarm_port: "2377"

# Defines first node in docker_swarm_managers_ansible_group as primary
docker_swarm_primary_manager: '{{ groups[docker_swarm_managers_ansible_group][0] }}'

# Task history retention limit (default 5)
docker_swarm_task_history_limit: '5'

# Define Ansible group which contains you Docker swarm workers
docker_swarm_workers_ansible_group: 'docker-swarm-workers'
```

Dependencies
------------

None

Example Playbook
----------------

```
- hosts: docker_hosts
  become: true
  vars:
  roles:
    - role: ansible-docker
    - role: ansible-docker-swarm
  tasks:
```

License
-------

BSD

Author Information
------------------


Larry Smith Jr.
- @mrlesmithjr
- http://everythingshouldbevirtual.com
- mrlesmithjr [at] gmail.com

[Ansible]: <https://www.ansible.com>
[Docker]: <https://www.docker.com>


Secure Docker Daemon
====================

Use to generate the key files and certificates needed to secure the Docker daemon. Certificates
and keys are created on the target host, which will typically be the Docker daemon host.  If you
plan on connecting to the Docker daemon from a remote host, add a play in your playbook that 
uses the copy module to copy the client files to the remote host. 

Configuring the daemon to actually use the certificates is a step you will need to add to your 
playbook or perform manually. How you add the required parameters to the service will depend
on your environment. Here are the parameters you will add: 

* --tlsverify 
* --tlscacert=/path/to/ca.pem 
* --tlscert=/path/to/server-cert.pem
* --tlskey=/path/to/server-key.pem   
* -H=tcp://hostname_or_ip:2376

For the client, place the client certificates in your home directory at ~/.docker. If you'll be 
executing the client on the target machine, the role will handle this for you. You will also need
to set the following environment variables:

* DOCKER_TLS_VERIFY=1
* DOCKER_HOST=tcp://hostname_or_ip:2376 

You can source the docker_env.sh script generated by this role to set the above variables. Source
it from your .profile or .bashrc to have the variables set automatically on login.


Requirements
------------

The following packages should already be installed on the target host: 

- openssl 


Role Variables
--------------

dds_system_tmp
> Path to temporary file space. Defaults to '/tmp'.

dds_country
> Two character country abbreviation. Used in the server CSR. Defaults to 'US'. 

dds_state
> State or provence name. Used in the server CSR. Defaults to 'North Carolina'.

dds_locality
> City name. Used in the server CSR. Defaults to 'Durham'. 

dds_organization
> Organization or company name. Used in the server CSR. Defaults to 'Acme Corp'.

dds_host 
> The host name or IP address used to access the Docker daemon. Defaults to '127.0.0.1'.

dds_passphrase
> A password used to secure key files. Defauts to 'Phrase123!'.

dds_server_cert_path
> Path where server certificates will be created. Defaults to '/etc/docker'.

dds_client_cert_path
> Path where client certificates will be created. Defaults to '~/.docker'.

dds_env_shell_path
> Dest directory for an optional shell script that will set the DOCKER env variables used by
> clients when connecting to the Docker daemon. Defaults to '~' (the user's home directory).

dds_install_shell
> If true, will install a shell script named *docker_env.sh* that sets DOCKER env variables. Source the shell script
> in your .profile or .bashrc to set the variables automatically at login. Defaults to true.  

dds_restart_docker
> Set to true, if the docker daemon should be restarted after create the certificates. Defaults to false.

Example Playbook
----------------

Here's an example playbook that executes our role:

    - name: Secure the docker daemon
      hosts: localhost
      connection: local
      gather_facts: no
      become: yes
      roles:
        - role: ansible.secure-docker-daemon
          dds_host: 10.0.2.15
          dds_server_cert_path: /etc/default/docker
          dds_restart_docker: no

License
-------

MIT

Authors
-------

[@chouseknecht](https://github.com/chouseknecht)

